# Module C: 单机系统

## 模块目的与范围

本模块理解操作系统的核心抽象，回答三个核心问题：

1. **如何管理进程？** - 理解进程、线程、调度
2. **如何管理内存？** - 理解虚拟内存、分页、缓存
3. **如何管理存储？** - 理解文件系统、持久化、一致性

## 必学概念与不变量清单

### 1. 进程与线程

**核心概念**：
- 进程：独立的执行单元，拥有独立的地址空间
- 线程：共享地址空间的执行单元
- 上下文切换：保存和恢复进程/线程状态

**关键不变量**：
- **进程隔离**：进程不能访问其他进程的内存
- **调度公平性**：所有进程最终都会被调度
- **原子性**：上下文切换是原子操作

**理解标准**：
- 能实现简单的进程调度器
- 能解释上下文切换的开销
- 能识别进程与线程的权衡

### 2. 虚拟内存

**核心概念**：
- 虚拟地址空间：每个进程看到的地址空间
- 页表：虚拟地址到物理地址的映射
- 缺页异常：访问未映射的页时触发

**关键不变量**：
- **内存保护**：用户态不能访问内核态内存
- **地址空间隔离**：进程不能访问其他进程的地址空间
- **页表一致性**：页表正确映射虚拟地址到物理地址

**理解标准**：
- 能实现简单的页表
- 能解释缺页异常的处理流程
- 能识别不同页表结构的权衡（单级 vs 多级）

### 3. 文件系统

**核心概念**：
- Inode：文件元数据
- 目录：文件名到 inode 的映射
- 缓存：减少磁盘访问

**关键不变量**：
- **崩溃一致性**：崩溃后文件系统仍然可用
- **原子性**：操作要么全部完成，要么全部不完成
- **持久化**：fsync 返回后数据不会丢失

**理解标准**：
- 能实现简单的文件系统
- 能解释日志或写时复制如何保证一致性
- 能识别不同文件系统的权衡（性能 vs 一致性）

### 4. 系统调用

**核心概念**：
- 系统调用：用户态到内核态的接口
- 特权级：用户态 vs 内核态
- 中断与异常：硬件事件触发的控制流转移

**关键不变量**：
- **特权隔离**：用户态不能直接执行特权指令
- **参数验证**：内核必须验证用户态传入的参数
- **原子性**：系统调用是原子操作

**理解标准**：
- 能实现简单的系统调用接口
- 能解释系统调用的开销
- 能识别系统调用的安全风险

### 5. 并发与同步

**核心概念**：
- 锁：互斥访问共享资源
- 条件变量：等待条件成立
- 信号量：计数器 + 等待队列

**关键不变量**：
- **互斥性**：同一时刻只有一个线程持有锁
- **无死锁**：系统不会陷入死锁状态
- **无饥饿**：所有线程最终都能获得锁

**理解标准**：
- 能实现简单的锁
- 能识别死锁的四个必要条件
- 能使用锁正确地保护共享数据

## 标志性产物

### 1. Mini OS Kernel

**目标**：实现一个最小的操作系统内核。

**核心特性**：
- 进程调度
- 虚拟内存
- 系统调用接口

**关键不变量**：
- 进程隔离
- 内存保护

**验收标准**：
- [ ] 能运行多个并发进程
- [ ] 能通过故障注入测试（进程崩溃）
- [ ] 能用基准测试测量上下文切换开销
- [ ] 有完整的设计文档

**仓库**：[mini-os](https://github.com/first-principles-cs/mini-os)

### 2. Simple File System

**目标**：实现一个简单的文件系统。

**核心特性**：
- Inode 与目录
- 缓存与预读
- 日志或写时复制

**关键不变量**：
- 崩溃一致性
- 原子性

**验收标准**：
- [ ] 能创建、读取、写入、删除文件
- [ ] 能通过故障注入测试（磁盘损坏、断电）
- [ ] 能用 fuzz 测试生成随机文件操作序列
- [ ] 有完整的设计文档

**仓库**：[simple-fs](https://github.com/first-principles-cs/simple-fs)

## 验收标准

完成本模块后，你应该能够：

- [ ] 实现简单的进程调度器
- [ ] 实现简单的虚拟内存系统
- [ ] 实现简单的文件系统
- [ ] 实现系统调用接口
- [ ] 使用锁正确地保护共享数据
- [ ] 解释不同操作系统设计的权衡

## 推荐项目顺序

1. **Mini OS Kernel** - 先理解进程与内存管理
2. **Simple File System** - 再理解持久化与一致性

## 参考资料

### 书籍

- **《操作系统导论》（Operating Systems: Three Easy Pieces）** - Remzi & Andrea
  - 现代操作系统教材，免费在线阅读

- **《深入理解计算机系统》（CSAPP）** - Bryant & O'Hallaron
  - 第 8-9 章：异常控制流、虚拟内存

- **《xv6: a simple, Unix-like teaching operating system》**
  - MIT 的教学操作系统，代码简洁

### 论文

- **"The UNIX Time-Sharing System"** - Ritchie & Thompson (1974)
  - UNIX 的原始论文

- **"Journaling the Linux ext2fs Filesystem"** - Tweedie (1998)
  - 日志文件系统

### 在线资源

- **MIT 6.828: Operating System Engineering**
  - 基于 xv6 的操作系统课程

- **Stanford CS140: Operating Systems**
  - 操作系统课程

## 与其他模块的关系

- **Module B (语言与执行)**：编译器生成的代码运行在操作系统上
- **Module D (数据系统)**：数据库依赖文件系统持久化数据
- **Module E (网络与分布式)**：分布式系统依赖操作系统的网络栈

---

下一步：学习 [Module D: 数据系统](./module-d-data-systems.md)。

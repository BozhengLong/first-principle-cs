# Module D: 数据系统

## 模块目的与范围

本模块理解数据库的核心，回答三个核心问题：

1. **如何存储数据？** - 理解存储引擎、索引结构
2. **如何保证一致性？** - 理解事务、并发控制
3. **如何查询数据？** - 理解查询优化、执行引擎

## 必学概念与不变量清单

### 1. 存储引擎

**核心概念**：
- B-tree：平衡树索引，适合读密集场景
- LSM-tree：日志结构合并树，适合写密集场景
- 预写日志（WAL）：保证持久化

**关键不变量**：
- **持久化**：写入的数据不会丢失
- **有序性**：范围查询返回有序结果
- **崩溃恢复**：崩溃后能恢复到一致状态

**理解标准**：
- 能实现 B-tree 或 LSM-tree
- 能解释不同索引结构的权衡
- 能实现预写日志

### 2. 事务与并发控制

**核心概念**：
- ACID：原子性、一致性、隔离性、持久性
- 并发控制：2PL（两阶段锁）、MVCC（多版本并发控制）
- 隔离级别：读未提交、读已提交、可重复读、串行化

**关键不变量**：
- **原子性**：事务要么全部提交，要么全部回滚
- **隔离性**：并发事务不会相互干扰
- **一致性**：事务保持数据库约束
- **持久性**：提交的事务不会丢失

**理解标准**：
- 能实现简单的事务管理器
- 能解释 2PL 与 MVCC 的权衡
- 能识别不同隔离级别的异常（脏读、不可重复读、幻读）

### 3. 查询优化

**核心概念**：
- 查询计划：执行查询的步骤
- 代价估算：估算查询计划的开销
- 优化规则：谓词下推、连接重排序

**关键不变量**：
- **语义保持**：优化不改变查询结果
- **代价单调性**：优化后的查询计划不应该更慢

**理解标准**：
- 能实现简单的查询优化器
- 能解释常见的优化规则
- 能估算查询计划的代价

### 4. 索引与查询执行

**核心概念**：
- 索引：加速查询的数据结构
- 扫描：全表扫描 vs 索引扫描
- 连接：嵌套循环连接、哈希连接、排序合并连接

**关键不变量**：
- **索引一致性**：索引与数据保持一致
- **查询正确性**：查询返回正确的结果

**理解标准**：
- 能实现简单的索引
- 能实现不同的连接算法
- 能解释不同连接算法的权衡

### 5. 复制与分片

**核心概念**：
- 主从复制：一个主节点，多个从节点
- 分片：将数据分散到多个节点
- 一致性哈希：动态分片

**关键不变量**：
- **复制一致性**：主从节点最终一致
- **分片完整性**：所有数据都在某个分片上

**理解标准**：
- 能实现简单的主从复制
- 能实现一致性哈希
- 能解释复制与分片的权衡

## 标志性产物

### 1. Storage Engine

**目标**：实现一个存储引擎。

**核心特性**：
- LSM-tree 或 B-tree
- 压缩与合并
- 预写日志

**关键不变量**：
- 持久化
- 有序性

**验收标准**：
- [ ] 能处理 1M+ 条记录
- [ ] 能通过基准测试对比不同索引结构
- [ ] 能通过故障注入测试崩溃恢复
- [ ] 有完整的设计文档

**仓库**：[storage-engine](https://github.com/first-principles-cs/storage-engine)

### 2. Transaction Manager

**目标**：实现一个事务管理器。

**核心特性**：
- MVCC 或 2PL
- 死锁检测
- 隔离级别

**关键不变量**：
- ACID 性质

**验收标准**：
- [ ] 能处理并发事务
- [ ] 能通过 Jepsen 风格的一致性测试
- [ ] 能检测并处理死锁
- [ ] 有完整的设计文档

**仓库**：[tx-manager](https://github.com/first-principles-cs/tx-manager)

## 验收标准

完成本模块后，你应该能够：

- [ ] 实现 B-tree 或 LSM-tree
- [ ] 实现事务管理器
- [ ] 实现查询优化器
- [ ] 实现不同的连接算法
- [ ] 实现主从复制
- [ ] 解释不同数据库设计的权衡

## 推荐项目顺序

1. **Storage Engine** - 先理解存储与索引
2. **Transaction Manager** - 再理解事务与并发控制

## 参考资料

### 书籍

- **《数据密集型应用系统设计》（Designing Data-Intensive Applications）** - Martin Kleppmann
  - 现代数据系统的权威指南

- **《数据库系统概念》（Database System Concepts）** - Silberschatz et al.
  - 经典的数据库教材

- **《数据库内幕》（Database Internals）** - Alex Petrov
  - 深入数据库实现细节

### 论文

- **"The Log-Structured Merge-Tree (LSM-Tree)"** - O'Neil et al. (1996)
  - LSM-tree 的原始论文

- **"Concurrency Control and Recovery in Database Systems"** - Bernstein et al. (1987)
  - 并发控制的经典论文

- **"A Critique of ANSI SQL Isolation Levels"** - Berenson et al. (1995)
  - 隔离级别的深入分析

### 在线资源

- **CMU 15-445: Database Systems**
  - 数据库系统课程

- **Stanford CS245: Principles of Data-Intensive Systems**
  - 数据密集型系统课程

## 与其他模块的关系

- **Module C (单机系统)**：数据库依赖文件系统持久化数据
- **Module E (网络与分布式)**：分布式数据库需要网络通信与一致性协议
- **Module F (AI 与搜索)**：搜索引擎需要索引与查询优化

---

下一步：学习 [Module E: 网络与分布式](./module-e-network-distributed.md)。

# Module E: 网络与分布式

## 模块目的与范围

本模块理解分布式系统的核心，回答三个核心问题：

1. **如何通信？** - 理解网络协议、RPC、消息队列
2. **如何保证一致性？** - 理解共识协议、复制、分区容错
3. **如何容错？** - 理解故障检测、恢复、降级

## 必学概念与不变量清单

### 1. 网络协议

**核心概念**：
- TCP：可靠的字节流
- UDP：不可靠的数据报
- HTTP：应用层协议

**关键不变量**：
- **可靠性**：TCP 保证数据要么全部到达，要么连接失败
- **有序性**：TCP 保证数据按发送顺序到达
- **流控制**：TCP 防止发送方压垮接收方

**理解标准**：
- 能实现简单的 TCP 客户端与服务器
- 能解释 TCP 的三次握手与四次挥手
- 能识别 TCP 与 UDP 的权衡

### 2. RPC 与序列化

**核心概念**：
- RPC：远程过程调用
- 序列化：将对象转换为字节流
- IDL：接口定义语言

**关键不变量**：
- **透明性**：RPC 应该像本地调用一样
- **幂等性**：重复的 RPC 调用不应该改变结果
- **超时处理**：RPC 必须处理超时

**理解标准**：
- 能实现简单的 RPC 框架
- 能实现序列化与反序列化
- 能处理 RPC 的失败场景

### 3. 共识协议

**核心概念**：
- Raft：易于理解的共识协议
- Paxos：经典的共识协议
- 领导者选举、日志复制、成员变更

**关键不变量**：
- **安全性**：已提交的日志不会丢失
- **活性**：系统最终会达成共识
- **领导者唯一性**：同一任期内只有一个领导者

**理解标准**：
- 能实现 Raft 或 Paxos
- 能解释共识协议的正确性证明
- 能识别共识协议的性能瓶颈

### 4. 复制与一致性

**核心概念**：
- 主从复制：一个主节点，多个从节点
- 多主复制：多个主节点
- 一致性模型：线性一致性、顺序一致性、最终一致性

**关键不变量**：
- **线性一致性**：操作看起来是瞬间完成的
- **因果一致性**：因果相关的操作保持顺序
- **最终一致性**：所有副本最终会收敛

**理解标准**：
- 能实现主从复制
- 能解释不同一致性模型的权衡
- 能用 Jepsen 测试验证一致性

### 5. 分区与容错

**核心概念**：
- CAP 定理：一致性、可用性、分区容错不可兼得
- 分片：将数据分散到多个节点
- 故障检测：检测节点是否存活

**关键不变量**：
- **分区容错**：网络分区时系统仍然可用
- **故障恢复**：节点故障后能自动恢复
- **数据完整性**：分片后所有数据都在某个节点上

**理解标准**：
- 能实现一致性哈希
- 能实现故障检测
- 能解释 CAP 定理的含义

## 标志性产物

### 1. Consensus Protocol

**目标**：实现一个共识协议（Raft 或 Paxos）。

**核心特性**：
- 领导者选举
- 日志复制
- 成员变更

**关键不变量**：
- 安全性
- 活性

**验收标准**：
- [ ] 能容忍 f < n/2 个节点故障
- [ ] 能通过网络分区测试
- [ ] 能用 Jepsen 验证一致性
- [ ] 有完整的设计文档

**仓库**：[consensus](https://github.com/first-principles-cs/consensus)

### 2. Distributed KV Store

**目标**：实现一个分布式键值存储。

**核心特性**：
- 一致性哈希
- 主从复制
- 故障检测与转移

**关键不变量**：
- 线性一致性或最终一致性
- 可用性：f < n/2 个节点故障时仍可用

**验收标准**：
- [ ] 能处理节点崩溃、网络分区
- [ ] 能用 Jepsen 验证一致性模型
- [ ] 能用基准测试测量吞吐量与延迟
- [ ] 有完整的设计文档

**仓库**：[dist-kv](https://github.com/first-principles-cs/dist-kv)

## 验收标准

完成本模块后，你应该能够：

- [ ] 实现 TCP 客户端与服务器
- [ ] 实现 RPC 框架
- [ ] 实现 Raft 或 Paxos
- [ ] 实现主从复制
- [ ] 实现一致性哈希
- [ ] 解释不同分布式系统设计的权衡

## 推荐项目顺序

1. **Consensus Protocol** - 先理解共识协议
2. **Distributed KV Store** - 再理解分布式存储

## 参考资料

### 书籍

- **《数据密集型应用系统设计》（DDIA）** - Martin Kleppmann
  - 第 5-9 章：复制、分区、事务、一致性

- **《分布式系统原理与范型》（Distributed Systems）** - Tanenbaum & Van Steen
  - 经典的分布式系统教材

### 论文

- **"In Search of an Understandable Consensus Algorithm"** - Ongaro & Ousterhout (2014)
  - Raft 的原始论文

- **"The Part-Time Parliament"** - Lamport (1998)
  - Paxos 的原始论文

- **"Dynamo: Amazon's Highly Available Key-value Store"** - DeCandia et al. (2007)
  - 最终一致性的经典案例

- **"Spanner: Google's Globally-Distributed Database"** - Corbett et al. (2012)
  - 全球分布式数据库

### 在线资源

- **MIT 6.824: Distributed Systems**
  - 分布式系统课程，基于 Raft

- **Jepsen**
  - 分布式系统测试工具

## 与其他模块的关系

- **Module C (单机系统)**：分布式系统依赖操作系统的网络栈
- **Module D (数据系统)**：分布式数据库需要共识协议与复制
- **Module F (AI 与搜索)**：分布式搜索引擎需要分片与复制

---

下一步：学习 [Module F: AI 与搜索系统](./module-f-ai-search-systems.md)。
